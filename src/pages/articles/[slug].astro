---
import Layout from "~/components/Layout.astro";
import Comments from "~/components/Comments.astro";
import { useStoryblok } from "@storyblok/astro";
import StoryblokComponent from "@storyblok/astro/StoryblokComponent.astro";
import { db, Comment, User, eq, desc } from "astro:db";

const { slug } = Astro.params;
const story = await useStoryblok(
  `cdn/stories/articles/${slug}`,
  {
    version: "draft",
  },
  {},
  Astro
);
const user = Astro.locals.user;
if (story.content.private && !user) {
  return Astro.redirect("/signin");
}
const comments = await db
  .select({
    id: Comment.id,
    createdAt: Comment.createdAt,
    updatedAt: Comment.updatedAt,
    parentId: Comment.parentId,
    body: Comment.body,
    name: User.name,
  })
  .from(Comment)
  .where(eq(Comment.articleId, story.uuid))
  .leftJoin(User, eq(Comment.userId, User.id))
  .orderBy(desc(Comment.createdAt));
---

<Layout title={story.content.title}>
  <StoryblokComponent blok={story.content} />
  <div class="max-w-lg mx-auto px-4">
    {
      !user && (
        <p class="font-bold text-xl">
          You have to{" "}
          <a href="/signin" class="underline text-blue-600">
            signin
          </a>{" "}
          if you want to comment.
        </p>
      )
    }
    <h4 class="text-2xl font-bold my-6">Comments[{comments.length}]</h4>
    <Comments articleId={story.uuid} comments={comments} />
  </div>
</Layout>
